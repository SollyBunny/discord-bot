#!/usr/bin/env node
function confload(){global.conf=JSON.parse(fs.readFileSync("./conf.json")),conf.main=conf.main||{},conf.main.prefix=conf.main.prefix||"!",conf.main.admins=conf.main.admins||[],conf.main.errcolor=conf.main.errcolor||[255,0,0],conf.reload=confload}async function setupmsg(){this.author.isNotPerson=this.author.bot||this.author.system||"0000"===this.author.discriminator,this.author.isAdmin=-1!==conf.main.admins.indexOf(this.author.id),this.embedreply=client._embedreply,this.webhookreply=client._webhookreply,this.errorreply=client._errorreply}__dirname!==process.cwd()&&process.chdir(__dirname),global.http=require("https"),global.fs=require("fs"),global.dc=require("discord.js"),dc.TEXT=0,dc.BIGTEXT=1,dc.INT=2,dc.NUM=3,dc.USER=4,dc.ROLE=5,dc.BOOL=6,dc.CHOICE=7,dc.typename=["Text","Text+","Integer","Number","User","Role","Boolean","Choice"],global.log=e=>{log.raw(36,e)},log.raw=(e,t)=>{console.log(`\x1b[${e}m[${log.time()}]\x1b[0m ${t}`)},log.warn=e=>{log.raw(33,e)},log.error=e=>{log.raw(31,e)},log.fake=(...e)=>{let t="",s=process.stdout.write;return process.stdout.write=(e,s,i)=>{t+=e},console.log(...e),process.stdout.write=s,t},log.time=()=>{let e=new Date;return`${e.getFullYear()}/${String(e.getMonth()+1).padStart(2,"0")}/${String(e.getDay()+1).padStart(2,"0")} ${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}.${String(e.getSeconds()).padStart(2,"0")}`},global.util={},util.levdis=(e,t)=>{let s=[],i=e.length,r=t.length;if(0==i)return r;if(0==r)return i;for(let n=0;n<=i;++n)s[n]=[],s[n][0]=n;for(let o=0;o<=r;++o)s[0][o]=o;for(let l=1;l<=r;++l)for(let d=1;d<=i;++d)e[d-1]===t[l-1]?s[d][l]=s[d-1][l-1]:s[d][l]=Math.min(s[d-1][l],s[d][l-1],s[d-1][l-1])+1;return s[i][r]},util.levdisclosest=(e,t,s)=>{let i,r=Number.MAX_SAFE_INTEGER,n;for(let o=0;o<e.length;++o){if((n=util.levdis(e[o],t))<2){i=e[o];break}!(n>s)&&n<r&&(i=e[o],r=n)}return i},util.levdisuserclosest=(e,t,s)=>{t=t.toLowerCase();let i,r=1/0,n,o;for(let l=0;l<e.size||e.length;++l){if((n=null===(o=e.at(l)).nickname?util.levdis(o.user.username.toLowerCase(),t):o.nickname?Math.min(util.levdis(o.nickname.toLowerCase(),t),util.levdis(o.user.username.toLowerCase(),t)):util.levdis(o.username.toLowerCase(),t))<s){i=o;break}n<r&&(i=o,r=n)}return i},util.fetch=function(e){return new Promise((t,s)=>{http.get(e,e=>{if(200!==e.statusCode){e.resume(),s(e.statusCode);return}let i="";e.on("data",e=>{i+=e}),e.on("end",()=>{t(i)})}).on("error",s)})},confload(),conf.main.token||(log.error("I need a token please!"),process.exit(1)),global.client=new dc.Client({intents:[dc.IntentsBitField.Flags.AutoModerationConfiguration,dc.IntentsBitField.Flags.AutoModerationExecution,dc.IntentsBitField.Flags.DirectMessageReactions,dc.IntentsBitField.Flags.DirectMessageTyping,dc.IntentsBitField.Flags.DirectMessages,dc.IntentsBitField.Flags.GuildBans,dc.IntentsBitField.Flags.GuildEmojisAndStickers,dc.IntentsBitField.Flags.GuildIntegrations,dc.IntentsBitField.Flags.GuildInvites,dc.IntentsBitField.Flags.GuildMembers,dc.IntentsBitField.Flags.GuildMessageReactions,dc.IntentsBitField.Flags.GuildMessageTyping,dc.IntentsBitField.Flags.GuildMessages,dc.IntentsBitField.Flags.GuildPresences,dc.IntentsBitField.Flags.GuildScheduledEvents,dc.IntentsBitField.Flags.GuildVoiceStates,dc.IntentsBitField.Flags.GuildWebhooks,dc.IntentsBitField.Flags.Guilds,dc.IntentsBitField.Flags.MessageContent],partials:[dc.Partials.User,dc.Partials.Channel,dc.Partials.GuildMember,dc.Partials.Message,dc.Partials.Reaction,dc.Partials.GuildScheduledEvent,dc.Partials.ThreadMember]}),client._embedreply=async function({msg:e="",title:t,color:s,colorraw:i,fields:r,thumb:n,image:o,url:l}){let d={description:e,title:t,color:i||(s?(s[0]<<16)+(s[1]<<8)+s[2]:0),fields:r,thumbnail:n?{url:n}:void 0,image:o?{url:o}:void 0,url:l};try{this.reply({embeds:[d]})}catch(c){try{this.channel.send({embeds:[d]})}catch(h){this.send({embeds:[d]})}}},client._errorreply=async function(e){await this.embedreply({msg:e,title:"Error",color:conf.main.errcolor})},client._webhookreply=async function(e,t){if(void 0===e.nickname){this.channel.send(t);return}let s=await this.channel.createWebhook({name:e.nickname||e.user.username,channel:this.channel,avatar:e.rawAvatarURL||e.avatarURL()||e.user.avatarURL()});await s.send({content:t,username:e.nickname||e.user.username,allowedMentions:{users:[],roles:[],channels:[]}}),await s.delete()},client.hooks={},client.hooks.ID=0,client.hooks.add=e=>{if(e.ID=client.hooks.ID,client.hooks.ID+=1,e.priority=e.priority||0,e.func.priority=e.priority,void 0===client.hooks[e.event]){client.on(e.event,client.hooks.run.bind(e.event)),client.hooks[e.event]=[e.func];return}let t=0;for(;t<client.hooks[e.event].length&&!(e.priority>client.hooks[e.event][t].priority);++t);client.hooks[e.event].splice(t,0,e.func),log(`Hook added ${e.event} (${e.priority})`)},client.hooks.sub=e=>{log(`Hook subbed ${e.event} (${e.priority})`);let t=0;for(;t<client.hooks[e.event].length&&client.hooks[e.event].ID!==e.ID;++t);client.hooks[e.event].splice(t,1)},client.hooks.run=async function(e){for(let t=0;t<client.hooks[this].length;++t)if(await client.hooks[this][t].apply(e))return},client.cmds={},client.cmds.serialize=async function(){let e=[];return Object.keys(client.cmds).forEach(t=>{if(t.admin||t.disabled)return;let s={name:t,description:client.cmds[t].desc||"No desc available",options:[],name_localizations:void 0,description_localizations:void 0,default_permission:void 0,default_member_permissions:client.cmds[t].perm&&String(client.cmds[t].perm),dm_permission:client.cmds[t].dm};if(client.cmds[t].args){let i=!1;client.cmds[t].args.forEach(e=>{let t={autocomplete:void 0,type:void 0,name:e[1],description:e[2],description_localizations:void 0,name_localizations:void 0};switch(i?t.required=!1:(i=!0,t.required=e[3]),e[0]){case dc.USER:t.type=6;break;case dc.TEXT:case dc.BIGTEXT:t.type=3,e[4]&&(t.min_length=String(e[4])),e[5]&&(t.max_length=String(e[5]));break;case dc.CHOICE:t.type=3,t.choices=e[4].map(e=>({name:e,name_localizations:void 0,value:e}));break;case dc.INT:t.type=4,e[4]&&(t.min_value=String(e[4])),e[5]&&(t.max_value=String(e[5]));break;case dc.NUM:t.type=10,t.min_value=e[4]&&String(e[4]),t.max_value=e[5]&&String(e[5])}s.options.push(t)})}e.push(s)}),e},client.cmds.push=async function(e){await client.rest.put(dc.Routes.applicationCommands(client.user.id),{body:await e})},client.cmds.serialize.disabled=!0,client.cmds.push.disabled=!0,client.cogs={},client.cogs.load=e=>{if(!e.endsWith(".js"))return;if(client.cogs[e])return log.warn(`Cog \`${e}\` already loaded`),!1;let t=require(`./cogs/${e}`);if(t.disabled){log.warn(`Cog \`${e}\` disabled`);return}return client.cogs[e]=t,conf[e]||(conf[e]={}),t.onload&&t.onload(),t.onloadready&&(client.isReady()?t.onloadready():client.once("ready",t.onloadready)),t.cmds&&Object.keys(t.cmds).forEach(e=>{client.cmds[e]=t.cmds[e]}),t.hooks&&t.hooks.forEach(client.hooks.add),log(`Cog ${e} loaded`),!0},client.cogs.unload=e=>(cog=client.cogs[e])?"function"!=typeof a&&(cog.onunload&&cog.onunload(),cog.cmds&&Object.keys(cog.cmds).forEach(e=>{delete client.cmds[e]}),cog.hooks&&cog.hooks.forEach(client.hooks.sub),delete client.cogs[e],delete require.cache[require.resolve(`./cogs/${e}`)],log(`Cog ${e} unloaded`),!0):(log.warn(`Cog ${e} not loaded`),!1),fs.readdirSync("./cogs/").forEach(client.cogs.load),client.cmds._serialized=client.cmds.serialize(),client.hooks.add({event:"ready",func:async function(){conf.main.activity&&client.user.setPresence({activities:[{name:conf.main.activity}]}),log(`Ready as ${client.user.tag}`),client.cmds.push(client.cmds._serialized)}}),client.hooks.add({event:"messageCreate",priority:1/0,func:setupmsg}),client.hooks.add({event:"interactionCreate",priority:1/0,func:setupmsg}),client.hooks.add({event:"interactionCreate",func:async function(){if(!this.isCommand())return;let e=client.cmds[this.commandName];if(!e)return;if(!1===this.inGuild()&&!1===e.dm){this.errorreply("This command cannot be used in DMs");return}log(`slashcmd ${this.user.tag}: ${this.commandName}`);let t=[];if(e.args)for(let s=0;s<e.args.length;++s){let i=this.options.get(e.args[s][1]);if(i){if(i=6===i.type?i.member||i.user:i.value,s[3]&&i.length&&0===i.length){this.errorreply(`\`${e.args[s][1]}\`: This field is required`);return}t.push(i)}else{if(s[3]){this.errorreply(`\`${e.args[s][1]}\`: This field is required`);return}t.push(void 0)}}e.hide&&this.inGuild()&&(await this.deferReply(),await this.deleteReply()),e.func.bind(this)(t)}}),client.hooks.add({event:"messageCreate",func:async function(){if(this.author.isNotPerson||!this.content.startsWith(conf.main.prefix))return;let e=this.content.indexOf(" "),t;if(-1===e?(this.cmdname=this.content.slice(1),this.content=""):(this.cmdname=this.content.slice(1,e),this.content=this.content.slice(e+1)),this.cmdname=this.cmdname.toLowerCase(),client.cmds[this.cmdname]||(this.cmdname=util.levdisclosest(Object.keys(client.cmds),this.cmdname,3),this.msgname)){if(t=client.cmds[this.cmdname],log(`cmd ${this.author.tag}: ${this.cmdname} ${this.content}`),this.author.isAdmin){if(!1===t.dm&&!this.inGuild()){this.errorreply("This command cannot be used in DMs");return}}else{if(t.admin){msg.errorreply("You need to be bot admin to use this command");return}if(this.inGuild()){if(t.perm&&!msg.member.permissions.has(t.perm)){this.errorreply("You are missing permissions:\n`"+new dc.PermissionsBitField(t.perms&~this.member.permissions.bitfield).toArray().join("`, `")+"`");return}}else if(!1===t.dm){this.errorreply("This command cannot be used in DMs");return}}if(t.args){if(0===this.content.length)this.content=[];else{this.content=this.content.split(/(?<=[^\\]) /g);for(let s=0;s<this.content.length;++s)this.content[s]=this.content[s].replace(/\\ /g," ")}if(this.content.length>t.args.length&&t.args.at(-1)[0]!==dc.BIGTEXT){this.errorreply("Too many arguments");return}for(let i=0;i<t.args.length;++i){if(void 0===this.content[i]){if(t.args[i][3]){this.errorreply(`\`${t.args[i][1]}\` This field is required`);return}continue}switch(t.args[i][0]){case dc.USER:let r,n=this.content[i].match(/[0-9]+/);if(n){n=n[0];try{r=await this.guild.members.fetch(n)}catch(o){if(t.dm)try{r=await client.users.fetch(n)}catch(l){}}}if(r||(r=this.channel.members?util.levdisuserclosest(this.channel.members,this.content[i],3):util.levdisuserclosest([client.user,this.author],this.content[i],3)),!r){this.errorreply(`\`${t.args[i][1]}\`: Invalid user`);return}this.content[i]=r;break;case dc.BIGTEXT:this.content[i]=this.content.slice(i).join(" ");case dc.TEXT:if(this.content[i]=this.content[i].replace(/\\ /g," "),t.args[i][4]&&t.args[i][4]>this.content[i].length||t.args[i][5]&&t.args[i][5]<this.content[i].length){t.args[i][4]?t.args[i][5]?this.errorreply(`\`${t.args[i][1]}\`: Length must be between ${t.args[i][4]} and ${t.args[i][5]}`):this.errorreply(`\`${t.args[i][1]}\`: Length must be above ${t.args[i][5]})`):this.errorreply(`\`${t.args[i][1]}\`: Length must be below ${t.args[i][5]})`);return}break;case dc.CHOICE:if(this.content[i]=this.content[i].toLowerCase(),-1===t.args[i][4].indexOf(this.content[i])&&(this.content[i]=util.levdisclosest(t.args[i][4],msg.content[i],3),void 0===this.content[i])){this.errorreply(`\`${t.args[i][1]}\`: Invalid choice, options are:
\``+t.args[i][4].join("`, `")+"`");return}break;case dc.INT:try{this.content[i]=Math.round(this.content[i])}catch(d){this.errorreply(`\`${t.args[i][1]}\`: Invalid Integer`);return}t.args[i][4]?t.args[i][5]?this.errorreply(`\`${t.args[i][1]}\`: Must be between ${t.args[i][4]} and ${t.args[i][5]}`):this.errorreply(`\`${t.args[i][1]}\`: Must be above ${t.args[i][5]})`):this.errorreply(`\`${t.args[i][1]}\`: Must be below ${t.args[i][5]})`);case dc.NUM:if(this.content[i]=Number(msg.content[i]),isNaN(this.content[i])){this.errorreply(`Invalid Number for \`${t.args[i][1]}\``);return}if(t.args[i][4]&&t.args[i][4]>this.content[i]||t.args[i][5]&&t.args[i][5]<this.content[i]){t.args[i][4]?t.args[i][5]?this.errorreply(`Invalid Number (must be imbetween ${t.args[i][4]} and ${t.args[i][5]}) for \`${t.args[i][1]}\``):this.errorreply(`Invalid Number (must be above ${t.args[i][4]}) for \`${t.args[i][1]}\``):this.errorreply(`Invalid Number (must be below ${t.args[i][5]}) for \`${t.args[i][1]}\``);return}}}t.hide&&this.inGuild()&&this.delete(),t.func.bind(this)(this.content)}else t.hide&&this.inGuild()&&this.delete(),t.func.bind(this)([])}}}),client.login(conf.main.token),process.on("uncaughtException",e=>{if(log.error(`${e} ${e.stack}`),!conf.main.error)return;let t={description:`\`\`\`${e}: ${e.stack}\`\`\``,title:"Error",color:16711680};client.channels.fetch(conf.main.error).then(e=>{e.send({embeds:[t]}).catch(()=>log.warn("Unable to send error message"))}).catch(()=>log("Unable to fetch error channel"))}),require.main===module&&require("repl").start();